# Define the server block for handling incoming requests
server {
    # Nginx will listen for requests on port 80, which is exposed from the container
    listen 80;

    # The main location block for the root URL
    location / {
        # Proxy all requests for the root path to the frontend service.
        # The hostname `rag-admin-frontend` is the name of the service in docker-compose.
        proxy_pass http://rag-admin-frontend:3000;

        # These headers are crucial for passing client information to the backend
        # like the original IP address and host.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Location block for all requests that start with /api/
    location /api/ {
        # This rewrite rule removes the "/api" prefix from the URL
        # before the request is sent to the backend.
        # For example, a request to /api/users becomes /users on the backend.
        rewrite ^/api/(.*)$ /$1 break;

        # Proxy the request to the backend service.
        # The hostname `fastapi-backend` is the name of the service in docker-compose.
        proxy_pass http://fastapi-backend:8000;

        # Set standard proxy headers for the backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
